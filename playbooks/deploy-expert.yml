---
- name: deploy-expert
  hosts: all
  vars:
    source_folder: "../3-expert/"
    destination_folder: "~/3-expert"

  tasks:
  - name: copy-expert-folder-contents
    ansible.builtin.copy:
      src: "{{ source_folder }}"
      dest: "{{ destination_folder }}/"
    register: task_result

  # Here we check and create the certificates stuff
  - name: create-certificates-folder-if-not-exists
    ansible.builtin.file:
      path: "{{ destination_folder }}/certificates"
      state: directory
      mode: "0755"

  - name: check-if-fullchain-exists
    ansible.builtin.stat:
      path: "{{ destination_folder }}/certificates/fullchain.pem"
    register: fullchain_file

  - name: check-if-privkey-exists
    ansible.builtin.stat:
      path: "{{ destination_folder }}/certificates/privkey.pem"
    register: privkey_file

  - name: generate-self-signed-certificates
    ansible.builtin.command: >
      openssl req -x509 -nodes -days 90
      -newkey rsa:4096
      -keyout {{ destination_folder }}/certificates/privkey.pem
      -out {{ destination_folder }}/certificates/fullchain.pem
      -subj "/CN={{ ssh_host }}"
      -addext "subjectAltName=DNS:{{ ssh_host }},DNS:www.{{ ssh_host }}"
    when: not fullchain_file.exists or not privkey_file.exists

  # Here we check and create our docker stuff
  - name: check-if-docker-compose-is-valid
    ansible.builtin.command:
      cmd: docker compose config
      chdir: "{{ destination_folder }}"
    register: compose_check
    changed_when: false
    when: task_result.changed

  - name: stop-containers-and-remove-images
    community.docker.docker_compose_v2:
      project_src: "{{ destination_folder }}"
      remove_orphans: true
      remove_volumes: true
      remove_images: local
      state: absent
    when: task_result.changed

  - name: start-containers-and-build-images
    community.docker.docker_compose_v2:
      project_src: "{{ destination_folder }}"
      state: present
      build: policy
      scale:
        webserver: 4
        api: 4
    when: task_result.changed
